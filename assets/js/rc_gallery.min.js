jQuery(document).ready(function () {
    var rcGallery = new RCGallery();
    rcGallery.lazyLoadImages();
});

var RCGallery = function () {
    "use strict";

    return {
        lazyLoadImages: function () {
            var interval = 5000,
                currentDelay = 0,
                rcGallery = this,
                galleries = document.querySelectorAll(".rc_gallery");

            [].forEach.call(galleries, function (gallery) {
                var imageContainers = document.querySelectorAll(".rc_galleryimg_container");

                [].forEach.call(imageContainers, function (imageContainer) {
                    if (imageContainer.dataset.thumbsexist === "true") {
                        rcGallery.populateThumbnail(imageContainer);
                        return;
                    }

                    setTimeout(function () {
                        var imgUrl = imageContainer.parentElement.href,
                            xhr = new XMLHttpRequest(),
                            startHeight = gallery.dataset.startheight,
                            rootUrl = gallery.dataset.rooturl,
                            requestUrl = rootUrl + "?option=com_ajax",
                            postData = "group=content&plugin=MakeThumbs&format=json&tmpl=component&img=" + imgUrl + "&start_height=" + startHeight;

                        xhr.onreadystatechange = function () {
                            if (this.readyState === 4 && this.status === 200) {
                                rcGallery.populateThumbnail(imageContainer);
                            }
                        };

                        xhr.open("POST", requestUrl, true);
                        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
                        xhr.send(postData);

                    }, currentDelay);

                    currentDelay += interval;
                });
            });
        },

        populateThumbnail: function (imageContainer) {
            var pictures = imageContainer.querySelectorAll("picture");

            [].forEach.call(pictures, function (picture) {
                var sources = picture.querySelectorAll("source");

                [].forEach.call(sources, function (source) {
                    source.srcset = source.dataset.srcset;

                });

                var imgs = picture.querySelectorAll("img");

                [].forEach.call(imgs, function (img) {
                    img.src = img.dataset.src;
                    img.attributes.alt = img.dataset.alt;
                });
            });
        }
    };
};
